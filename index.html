<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sistem Aset YPKT - V20</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #2563eb; 
            --dark: #1e293b; 
            --sidebar-bg: #0f172a;
            --light: #f3f4f6;
            --red: #ef4444;
            --green: #10b981;
            --orange: #f97316;
        }
        body { font-family: 'Inter', sans-serif; margin: 0; background: var(--light); height: 100vh; overflow: hidden; }
        * { box-sizing: border-box; }

        /* --- 1. UTILITIES (SOROK SCROLLBAR) --- */
        .hide-scroll { overflow-y: auto; scrollbar-width: none; -ms-overflow-style: none; }
        .hide-scroll::-webkit-scrollbar { display: none; }

        /* --- 2. LANDING PAGE (3 PINTU) --- */
        #landing-page {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            z-index: 9999; transition: transform 0.4s ease;
        }
        .landing-grid { display: flex; flex-direction: column; gap: 15px; width: 90%; max-width: 340px; }
        
        .landing-card {
            background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.1);
            padding: 20px; border-radius: 12px; cursor: pointer; display: flex; align-items: center; gap: 15px; color: white;
            backdrop-filter: blur(10px); transition: 0.2s;
        }
        .landing-card:active { transform: scale(0.96); background: rgba(255,255,255,0.15); }
        .icon-box { font-size: 1.8rem; width: 50px; text-align: center; }
        .card-title { font-weight: 700; font-size: 1rem; }
        .card-sub { font-size: 0.8rem; color: #94a3b8; }

        /* Special Color for Fast Track */
        .card-fast { border-color: rgba(16, 185, 129, 0.4); background: rgba(16, 185, 129, 0.1); }

        /* --- 3. LAYOUT (SIDEBAR + CONTENT) --- */
        #app-container { display: none; height: 100vh; width: 100%; }
        #app-container.active { display: flex; }

        /* SIDEBAR (Responsive) */
        .sidebar {
            width: 260px; background: var(--sidebar-bg); color: #cbd5e1;
            display: flex; flex-direction: column; flex-shrink: 0;
            transition: transform 0.3s ease; z-index: 1000;
        }
        .brand { padding: 25px; font-size: 1.2rem; font-weight: 700; color: white; border-bottom: 1px solid #334155; }
        .nav-links { padding: 20px 10px; flex: 1; }
        .nav-item {
            padding: 14px; margin-bottom: 5px; border-radius: 8px; cursor: pointer;
            display: flex; align-items: center; gap: 12px; font-weight: 500; transition: 0.2s;
        }
        .nav-item:hover { background: rgba(255,255,255,0.05); color: white; }
        .nav-item.active { background: var(--primary); color: white; }
        
        /* CONTENT AREA */
        .main-content { flex: 1; position: relative; display: flex; flex-direction: column; background: var(--light); }
        .top-header {
            height: 60px; background: white; padding: 0 20px; display: flex; align-items: center; justify-content: space-between;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05); flex-shrink: 0;
        }
        .menu-toggle { display: none; font-size: 1.5rem; cursor: pointer; color: var(--dark); margin-right: 15px; }
        
        .page-area { flex: 1; padding: 20px; overflow-y: auto; }
        .page-section { display: none; max-width: 800px; margin: 0 auto; animation: fadeUp 0.3s; }
        .page-section.active { display: block; }

        /* CARDS & FORMS */
        .card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); margin-bottom: 20px; }
        label { display: block; font-weight: 600; font-size: 0.9rem; color: #475569; margin-bottom: 6px; margin-top: 15px; }
        input, select, textarea { width: 100%; padding: 12px; border: 1px solid #cbd5e1; border-radius: 8px; font-size: 1rem; background: #f8fafc; font-family: inherit; }
        
        /* BUTTONS */
        .btn { width: 100%; padding: 14px; border: none; border-radius: 8px; color: white; font-weight: 600; cursor: pointer; margin-top: 20px; font-size: 1rem; }
        .btn:active { transform: scale(0.98); }
        .btn-blue { background: var(--primary); }
        .btn-green { background: var(--green); }
        .btn-excel { background: #15803d; }

        /* CANVAS */
        .canvas-wrapper {
            border: 2px dashed #94a3b8; border-radius: 8px; height: 180px; background: white;
            position: relative; touch-action: none; 
        }
        canvas { width: 100%; height: 100%; display: block; }
        .btn-clear-sign {
            position: absolute; bottom: 8px; right: 8px; background: #ef4444; color: white;
            font-size: 0.75rem; padding: 5px 10px; border-radius: 6px; cursor: pointer; z-index: 10;
        }

        /* RESPONSIVE */
        @media (max-width: 768px) {
            .sidebar { position: fixed; height: 100%; left: -260px; width: 260px; box-shadow: 2px 0 10px rgba(0,0,0,0.2); }
            .sidebar.open { transform: translateX(260px); }
            .menu-toggle { display: block; }
            .overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 900; }
            .overlay.active { display: block; }
        }
        @keyframes fadeUp { from{opacity:0; transform:translateY(10px);} to{opacity:1; transform:translateY(0);} }
    </style>
</head>
<body>

    <div class="overlay" onclick="toggleSidebar()"></div>

    <div id="landing-page">
        <h1 style="color:white; margin-bottom:5px">Sistem Aset YPKT</h1>
        <p style="color:#94a3b8; margin-top:0; margin-bottom:30px">Versi 20 - Excel Pro</p>

        <div class="landing-grid">
            <div class="landing-card" onclick="openMode('public')">
                <div class="icon-box">üìù</div>
                <div><div class="card-title">Cikgu / Staff</div><div class="card-sub">Isi Borang Serahan</div></div>
            </div>

            <div class="landing-card card-fast" onclick="authFastTrack()">
                <div class="icon-box">üì¶</div>
                <div><div class="card-title">Serahan Pulang</div><div class="card-sub">Fast Track (Berkunci)</div></div>
            </div>

            <div class="landing-card" onclick="authAdmin()">
                <div class="icon-box">üõ°Ô∏è</div>
                <div><div class="card-title">Admin Dashboard</div><div class="card-sub">Full Access + Excel</div></div>
            </div>
        </div>
    </div>

    <div id="app-container">
        
        <div class="sidebar" id="sidebar" style="display:none">
            <div class="brand">Admin Panel üîí</div>
            <div class="nav-links hide-scroll">
                <div class="nav-item active" onclick="navTo('adm-terima', this)">üì• 1. Penerimaan</div>
                <div class="nav-item" onclick="navTo('adm-jejak', this)">üìç 2. Jejak Aset</div>
                <div class="nav-item" onclick="navTo('adm-pulang', this)">üì¶ 3. Serahan Pulang</div>
                <div class="nav-item" onclick="navTo('adm-nota', this)">üìå 4. Nota (Sulit)</div>
                <hr style="border-color:#334155">
                <div class="nav-item" onclick="downloadExcelAll()" style="color:#4ade80">üìä Download Excel</div>
                <div class="nav-item" onclick="location.reload()" style="color:#f87171">üö™ Log Keluar</div>
            </div>
        </div>

        <div class="main-content">
            <div class="top-header">
                <div style="display:flex; align-items:center;">
                    <div class="menu-toggle" id="menu-btn" onclick="toggleSidebar()">‚ò∞</div>
                    <h3 style="margin:0" id="header-title">Menu</h3>
                </div>
                <button onclick="location.reload()" style="background:none; border:none; color:var(--primary); font-weight:600; cursor:pointer">üè† Menu Utama</button>
            </div>

            <div class="page-area hide-scroll">
                
                <div id="page-cikgu" class="page-section">
                    <div class="card">
                        <h2 style="color:var(--primary); margin-top:0">üìù Borang Serahan</h2>
                        <label>Nama Cikgu / Staff</label><input type="text" id="c_name">
                        <label>Lokasi YPKT</label>
                        <select id="c_loc">
                            <option value="">-- Pilih --</option>
                            <option>YPKT Ibu Pejabat</option>
                            <option>YPKT Kuala Nerus</option>
                            <option>YPKT Marang</option>
                            <option>YPKT Hulu Terengganu</option>
                            <option>YPKT Dungun</option>
                            <option>YPKT Kemaman</option>
                            <option>YPKT Besut</option>
                            <option>YPKT Setiu</option>
                        </select>
                        <label>Jenis Aset</label><select id="c_type"><option>Laptop</option><option>PC</option><option>Printer</option><option>Lain-lain</option></select>
                        <label>No Siri</label><input type="text" id="c_serial">
                        <label>Masalah</label><textarea id="c_issue" rows="3"></textarea>
                        <label>Tarikh</label><input type="text" id="c_date" readonly>
                        
                        <label>Tandatangan</label>
                        <div class="canvas-wrapper">
                            <canvas id="cvs_cikgu"></canvas>
                            <div class="btn-clear-sign" onclick="clearCanvas('cvs_cikgu')">Padam</div>
                        </div>
                        <button class="btn btn-blue" onclick="submitCikgu()">HANTAR</button>
                    </div>
                </div>

                <div id="page-fast-track" class="page-section">
                    <div class="card" style="border-left:5px solid var(--green)">
                        <h2 style="margin-top:0; color:var(--green)">üì¶ Fast Track: Serahan Pulang</h2>
                        <p>Senarai aset siap dibaiki yang sedia untuk diambil.</p>
                    </div>
                    <div id="list-fast-track"></div>
                </div>

                <div id="adm-terima" class="page-section">
                    <h2 style="margin-top:0">üì• Menunggu Penerimaan</h2>
                    <div id="list-terima"></div>
                </div>

                <div id="adm-jejak" class="page-section">
                    <h2 style="margin-top:0">üìç Live Tracking</h2>
                    <div class="card" style="background:#eff6ff">
                        <select id="track-sel" style="margin-bottom:10px"></select>
                        <div style="display:flex; gap:10px"><input id="track-txt" placeholder="Status..."><button onclick="addTrack()" class="btn btn-blue" style="margin-top:0; width:auto">Update</button></div>
                    </div>
                    <div id="list-jejak"></div>
                </div>

                <div id="adm-pulang" class="page-section">
                    <h2>üì¶ Pengurusan Serahan Pulang</h2>
                    <div id="list-pulang-admin"></div>
                </div>

                <div id="adm-nota" class="page-section">
                    <div class="card">
                        <h2>üìå Nota Sulit Admin</h2>
                        <textarea id="notepad" rows="15" oninput="saveNote()"></textarea>
                    </div>
                </div>

            </div>
        </div>
    </div>

<script>
    let db = JSON.parse(localStorage.getItem('db_v20')) || [];
    let currentMode = ''; 

    // --- 1. MODE & NAVIGATION ---
    function openMode(mode) {
        document.getElementById('landing-page').style.transform = 'translateY(-100%)';
        setTimeout(() => {
            document.getElementById('app-container').classList.add('active');
            document.querySelectorAll('.page-section').forEach(p => p.classList.remove('active'));

            if(mode === 'public') {
                document.getElementById('sidebar').style.display = 'none';
                document.getElementById('menu-btn').style.display = 'none';
                document.getElementById('page-cikgu').classList.add('active');
                document.getElementById('header-title').innerText = 'Borang Cikgu';
                document.getElementById('c_date').value = new Date().toLocaleString();
                initCanvas('cvs_cikgu');
            }
        }, 300);
    }

    function authFastTrack() {
        let p = prompt("Masukkan Password Fast Track (Cth: 1234):");
        if(p === "1234") { // Password Fast Track
            document.getElementById('landing-page').style.transform = 'translateY(-100%)';
            setTimeout(() => {
                document.getElementById('app-container').classList.add('active');
                document.getElementById('sidebar').style.display = 'none';
                document.getElementById('menu-btn').style.display = 'none';
                document.querySelectorAll('.page-section').forEach(p => p.classList.remove('active'));
                
                document.getElementById('page-fast-track').classList.add('active');
                document.getElementById('header-title').innerText = 'Fast Track Pulang';
                renderListPulang('list-fast-track');
            }, 300);
        } else { alert("Password Salah!"); }
    }

    function authAdmin() {
        let p = prompt("Masukkan Password Admin:");
        if(p === "admin123") {
            document.getElementById('landing-page').style.transform = 'translateY(-100%)';
            setTimeout(() => {
                document.getElementById('app-container').classList.add('active');
                document.getElementById('sidebar').style.display = 'flex'; // Show Sidebar
                document.getElementById('menu-btn').style.display = 'block';
                navTo('adm-terima', document.querySelector('.nav-item')); // Default tab
            }, 300);
        } else { alert("Akses Ditolak!"); }
    }

    function navTo(pageId, el) {
        document.querySelectorAll('.page-section').forEach(p => p.classList.remove('active'));
        document.getElementById(pageId).classList.add('active');
        
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        if(el) el.classList.add('active');

        // Close sidebar on mobile
        document.getElementById('sidebar').classList.remove('open');
        document.querySelector('.overlay').classList.remove('active');

        if(pageId === 'adm-terima') renderTerima();
        if(pageId === 'adm-jejak') renderJejak();
        if(pageId === 'adm-pulang') renderListPulang('list-pulang-admin');
        if(pageId === 'adm-nota') document.getElementById('notepad').value = localStorage.getItem('nota_v20') || '';
    }

    function toggleSidebar() {
        document.getElementById('sidebar').classList.toggle('open');
        document.querySelector('.overlay').classList.toggle('active');
    }

    // --- 2. LOGIC: CIKGU SUBMIT ---
    function submitCikgu() {
        let n = document.getElementById('c_name').value;
        let l = document.getElementById('c_loc').value;
        let s = document.getElementById('c_serial').value;
        if(!n || !l || !s) return alert("Sila isi maklumat wajib!");

        db.push({
            id: Date.now(),
            date: document.getElementById('c_date').value,
            name: n, loc: l, type: document.getElementById('c_type').value,
            serial: s, issue: document.getElementById('c_issue').value,
            status: 'PENDING',
            logs: [],
            // Admin data
            admName: '', admTime: '',
            // Return data
            retName: '', retTime: ''
        });
        localStorage.setItem('db_v20', JSON.stringify(db));
        alert("Borang Berjaya Dihantar!");
        location.reload();
    }

    // --- 3. LOGIC: ADMIN TERIMA ---
    function renderTerima() {
        let div = document.getElementById('list-terima');
        div.innerHTML = '';
        let list = db.filter(x => x.status === 'PENDING').reverse();
        if(list.length === 0) div.innerHTML = '<p class="text-center">Tiada data.</p>';
        
        list.forEach(i => {
            div.innerHTML += `
            <div class="card" style="border-left:5px solid #f59e0b">
                <h3>${i.type} (${i.serial})</h3>
                <p>${i.name} - ${i.loc}<br><span style="color:red">Masalah: ${i.issue}</span></p>
                <hr>
                <input id="adm_n_${i.id}" placeholder="Nama Admin...">
                <div class="canvas-wrapper" style="height:120px"><canvas id="cvs_adm_${i.id}"></canvas></div>
                <button class="btn btn-blue" onclick="saveTerima(${i.id})">Terima</button>
            </div>`;
            setTimeout(()=>initCanvas(`cvs_adm_${i.id}`),100);
        });
    }

    function saveTerima(id) {
        let n = document.getElementById(`adm_n_${id}`).value;
        if(!n) return alert("Nama Admin wajib isi!");
        let idx = db.findIndex(x => x.id === id);
        db[idx].status = 'RECEIVED';
        db[idx].admName = n;
        db[idx].admTime = new Date().toLocaleString();
        db[idx].logs.push(`Diterima Admin: ${n} (${db[idx].admTime})`);
        localStorage.setItem('db_v20', JSON.stringify(db));
        renderTerima();
    }

    // --- 4. LOGIC: JEJAK ---
    function renderJejak() {
        let sel = document.getElementById('track-sel');
        sel.innerHTML = '<option value="">Pilih Aset...</option>';
        db.filter(x => x.status === 'RECEIVED').forEach(x => {
            sel.innerHTML += `<option value="${x.id}">${x.type} (${x.name})</option>`;
        });
        
        let div = document.getElementById('list-jejak');
        div.innerHTML = '';
        db.filter(x => x.status !== 'PENDING').reverse().forEach(i => {
            div.innerHTML += `<div class="card"><b>${i.type} (${i.serial})</b><br>Status: ${i.status}<br><small>${i.logs.join('<br>')}</small></div>`;
        });
    }
    
    function addTrack() {
        let id = document.getElementById('track-sel').value;
        let txt = document.getElementById('track-txt').value;
        if(!id || !txt) return;
        let idx = db.findIndex(x=>x.id==id);
        db[idx].logs.push(`${txt} (${new Date().toLocaleString()})`);
        localStorage.setItem('db_v20', JSON.stringify(db));
        renderJejak();
    }

    // --- 5. LOGIC: SERAHAN PULANG (FAST TRACK & ADMIN) ---
    function renderListPulang(targetId) {
        let div = document.getElementById(targetId);
        div.innerHTML = '';
        let list = db.filter(x => x.status === 'RECEIVED').reverse();
        
        if(list.length === 0) div.innerHTML = '<p>Tiada aset sedia dipulangkan.</p>';

        list.forEach(i => {
            div.innerHTML += `
            <div class="card" style="border-left:5px solid #10b981">
                <h3>${i.type} (${i.serial})</h3>
                <p>Milik: ${i.name} (${i.loc})</p>
                <div style="background:#f0fdf4; padding:10px; border-radius:8px">
                    <input id="ret_n_${i.id}" placeholder="Nama Penerima...">
                    <label>Sign Penerima:</label>
                    <div class="canvas-wrapper" style="height:140px"><canvas id="cvs_ret_${i.id}"></canvas><div class="btn-clear-sign" onclick="clearCanvas('cvs_ret_${i.id}')">Padam</div></div>
                    <button class="btn btn-green" onclick="savePulang(${i.id}, '${targetId}')">Sahkan Serahan</button>
                </div>
            </div>`;
            setTimeout(()=>initCanvas(`cvs_ret_${i.id}`),100);
        });
    }

    function savePulang(id, viewId) {
        let n = document.getElementById(`ret_n_${id}`).value;
        if(!n) return alert("Nama Penerima wajib isi!");
        let idx = db.findIndex(x => x.id === id);
        db[idx].status = 'RETURNED';
        db[idx].retName = n;
        db[idx].retTime = new Date().toLocaleString();
        db[idx].logs.push(`Dipulangkan kpd: ${n} (${db[idx].retTime})`);
        localStorage.setItem('db_v20', JSON.stringify(db));
        renderListPulang(viewId);
    }

    // --- 6. EXCEL FULL FIX ---
    function downloadExcelAll() {
        if(db.length === 0) return alert("Tiada data.");
        
        // Header Column
        let headers = ["ID", "Tarikh Lapor", "Nama Cikgu", "Lokasi", "Jenis", "No Siri", "Masalah", "Status", "Admin Terima", "Tarikh Terima", "Penerima Akhir", "Tarikh Pulang"];
        
        let csvRows = [];
        csvRows.push(headers.join(","));

        db.forEach(row => {
            // Helper to clean text for CSV (remove newlines, escape quotes)
            const clean = (text) => {
                if(!text) return "";
                let str = String(text).replace(/"/g, '""'); // Escape double quotes
                str = str.replace(/(\r\n|\n|\r)/gm, " "); // Replace newlines with space
                return `"${str}"`; // Wrap in quotes
            };

            let values = [
                row.id,
                clean(row.date),
                clean(row.name),
                clean(row.loc),
                clean(row.type),
                clean(row.serial),
                clean(row.issue),
                clean(row.status),
                clean(row.admName),
                clean(row.admTime),
                clean(row.retName),
                clean(row.retTime)
            ];
            csvRows.push(values.join(","));
        });

        let csvString = csvRows.join("\n");
        let a = document.createElement('a');
        a.href = 'data:text/csv;charset=utf-8,' + encodeURIComponent(csvString);
        a.download = 'Data_Aset_Lengkap.csv';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
    }

    function saveNote() { localStorage.setItem('nota_v20', document.getElementById('notepad').value); }

    // --- 7. CANVAS ENGINE (FIXED) ---
    function initCanvas(id) {
        let c = document.getElementById(id);
        if(!c) return;
        let rect = c.getBoundingClientRect();
        c.width = rect.width; c.height = rect.height;
        let ctx = c.getContext('2d');
        ctx.lineWidth = 2; ctx.strokeStyle = '#000';
        
        let drawing = false;
        const getPos = (e) => {
            let r = c.getBoundingClientRect();
            return { 
                x: (e.touches ? e.touches[0].clientX : e.clientX) - r.left,
                y: (e.touches ? e.touches[0].clientY : e.clientY) - r.top
            };
        };

        ['mousedown','touchstart'].forEach(evt => c.addEventListener(evt, (e)=>{ 
            if(evt=='touchstart') e.preventDefault();
            drawing=true; ctx.beginPath(); ctx.moveTo(getPos(e).x, getPos(e).y); 
        }));
        ['mousemove','touchmove'].forEach(evt => c.addEventListener(evt, (e)=>{ 
            if(evt=='touchmove') e.preventDefault();
            if(drawing){ ctx.lineTo(getPos(e).x, getPos(e).y); ctx.stroke(); } 
        }));
        ['mouseup','touchend'].forEach(evt => c.addEventListener(evt, ()=>{ drawing=false; }));
    }
    function clearCanvas(id) { let c=document.getElementById(id); c.getContext('2d').clearRect(0,0,c.width,c.height); }

</script>
</body>
</html>
